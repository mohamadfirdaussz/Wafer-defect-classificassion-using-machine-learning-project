<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WM-811K Wafer Defect Dashboard</title>
    <meta name="description" content="Interactive dashboard for WM-811K semiconductor wafer defect classification using machine learning">
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <div class="container">
        <header>
            <div class="header-content">
                <h1>ðŸ”¬ Wafer Defect Analysis</h1>
                <p class="subtitle">WM-811K Machine Learning Pipeline Dashboard</p>
            </div>
            <div class="header-controls">
                <button id="theme-toggle" class="btn icon-btn" title="Toggle Theme">ðŸŒ™</button>
                <div class="status-badge">Pipeline Active</div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="nav-tabs">
            <button class="nav-tab active" data-section="overview">Overview</button>
            <button class="nav-tab" data-section="classifier">Classifier</button>
            <button class="nav-tab" data-section="analytics">Analytics</button>
            <button class="nav-tab" data-section="models">Models</button>
        </nav>

        <!-- ============ OVERVIEW SECTION ============ -->
        <div id="section-overview" class="section-content active">
            <!-- Pipeline Overview -->
            <section id="overview" class="glass-card">
                <h2>Pipeline Overview</h2>
                
                <div class="pipeline-stages">
                    <div class="stage"><div class="stage-num">Stage 1</div><div class="stage-name">Data Loading</div><span class="stage-arrow">â†’</span></div>
                    <div class="stage"><div class="stage-num">Stage 2</div><div class="stage-name">Feature Extraction</div><span class="stage-arrow">â†’</span></div>
                    <div class="stage"><div class="stage-num">Stage 3</div><div class="stage-name">Preprocessing</div><span class="stage-arrow">â†’</span></div>
                    <div class="stage"><div class="stage-num">Stage 3.5</div><div class="stage-name">Expansion</div><span class="stage-arrow">â†’</span></div>
                    <div class="stage"><div class="stage-num">Stage 4</div><div class="stage-name">Selection</div><span class="stage-arrow">â†’</span></div>
                    <div class="stage"><div class="stage-num">Stage 5</div><div class="stage-name">Training</div><span class="stage-arrow">â†’</span></div>
                    <div class="stage"><div class="stage-num">Stage 6</div><div class="stage-name">Optimization</div></div>
                </div>
                
                <div class="grid-stats" id="stats-grid">
                    <div class="stat-item skeleton"><span class="stat-value">--</span><span class="stat-label">Total Samples</span></div>
                    <div class="stat-item skeleton"><span class="stat-value">--</span><span class="stat-label">Train Size</span></div>
                    <div class="stat-item skeleton"><span class="stat-value">--</span><span class="stat-label">Test Size</span></div>
                    <div class="stat-item skeleton"><span class="stat-value">--</span><span class="stat-label">Features Selected</span></div>
                </div>
                
                <p>A leak-proof machine learning pipeline for classifying semiconductor wafer defects using traditional ML techniques, high-dimensional feature engineering, and Optuna hyperparameter optimization.</p>
            </section>

            <!-- Class Distribution -->
            <section id="distribution" class="glass-card">
                <h2>Class Distribution</h2>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="distribution-chart"></canvas>
                </div>
            </section>

            <!-- Defect Gallery -->
            <section id="gallery">
                <h2>Defect Class Gallery</h2>
                <div class="gallery-grid" id="gallery-grid"></div>
            </section>
        </div>

        <!-- ============ CLASSIFIER SECTION ============ -->
        <div id="section-classifier" class="section-content">
            <section id="classifier" class="glass-card">
                <h2>Interactive Defect Classifier</h2>
                <div class="classifier-container">
                    <div class="classifier-input">
                        <div id="wafer-preview" class="image-wrapper large">
                            <div class="placeholder">Select a wafer to classify</div>
                        </div>
                        
                        <div class="controls-row">
                            <select id="class-filter" class="btn secondary select-filter">
                                <option value="all">Any Defect</option>
                                <option value="0">Center</option>
                                <option value="1">Donut</option>
                                <option value="2">Edge-Loc</option>
                                <option value="3">Edge-Ring</option>
                                <option value="4">Loc</option>
                                <option value="5">Random</option>
                                <option value="6">Scratch</option>
                                <option value="7">None</option>
                            </select>
                            <button id="btn-random" class="btn primary">Pick Wafer</button>
                        </div>
                        
                        <!-- Confidence Threshold Slider -->
                        <div class="slider-container">
                            <label for="threshold-slider">Confidence Threshold: <span id="threshold-value">0%</span></label>
                            <input type="range" id="threshold-slider" min="0" max="100" value="0" class="slider">
                        </div>
                        
                        <div class="auto-classify-toggle">
                            <input type="checkbox" id="auto-classify">
                            <label for="auto-classify">Auto-classify after picking</label>
                        </div>
                        
                        <button id="btn-classify" class="btn secondary full-width" disabled>Classify Wafer</button>
                        
                        <div class="shortcut-hint">
                            <kbd>Space</kbd> Pick Wafer &nbsp;&nbsp; <kbd>Enter</kbd> Classify
                        </div>
                    </div>

                    <div class="classifier-results">
                        <div class="result-item">
                            <span class="label">Ground Truth</span>
                            <span id="gt-label" class="val">---</span>
                            <div id="match-indicator"></div>
                        </div>
                        <div class="result-divider"></div>
                        
                        <div class="result-item">
                            <span class="label">Model Prediction</span>
                            <span id="pred-label" class="val">---</span>
                            <span id="confidence-badge" class="confidence-badge"></span>
                        </div>
                        <div class="result-divider"></div>
                        
                        <div class="result-item">
                            <span class="label">Class Probabilities</span>
                            <div id="proba-container" class="proba-list">
                                <div class="placeholder-text">Run classification to see probabilities</div>
                            </div>
                        </div>
                        
                        <div class="history-panel" id="history-panel" style="display: none;">
                            <div class="history-title">Recent Classifications</div>
                            <div class="history-items" id="history-items"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Batch Classification -->
            <section id="batch" class="glass-card">
                <h2>Batch Classification</h2>
                <p class="section-desc">Classify multiple random wafers at once to test model performance.</p>
                <div class="batch-controls">
                    <div class="input-group">
                        <label for="batch-size">Batch Size:</label>
                        <input type="number" id="batch-size" value="20" min="5" max="50" class="number-input">
                    </div>
                    <button id="btn-batch" class="btn primary">Run Batch Classification</button>
                </div>
                <div id="batch-results" class="batch-results" style="display: none;">
                    <div class="batch-summary">
                        <div class="batch-stat"><span class="batch-val" id="batch-accuracy">--</span><span class="batch-label">Accuracy</span></div>
                        <div class="batch-stat"><span class="batch-val" id="batch-correct">--</span><span class="batch-label">Correct</span></div>
                        <div class="batch-stat"><span class="batch-val" id="batch-total">--</span><span class="batch-label">Total</span></div>
                    </div>
                    <div class="batch-items" id="batch-items"></div>
                </div>
            </section>
        </div>

        <!-- ============ ANALYTICS SECTION ============ -->
        <div id="section-analytics" class="section-content">
            <!-- Confusion Matrix -->
            <section id="confusion" class="glass-card">
                <h2>Confusion Matrix</h2>
                <div class="cm-toggle">
                    <button class="cm-btn active" data-mode="counts">Counts</button>
                    <button class="cm-btn" data-mode="percent">Percentages</button>
                </div>
                <div class="confusion-matrix" id="confusion-matrix"></div>
            </section>

            <!-- Per-Class Metrics -->
            <section id="class-metrics" class="glass-card">
                <h2>Per-Class Performance</h2>
                <div class="chart-container" style="height: 350px;">
                    <canvas id="class-metrics-chart"></canvas>
                </div>
            </section>

            <!-- Feature Importance -->
            <section id="features" class="glass-card">
                <h2>Top Feature Importance</h2>
                <div class="chart-container" style="height: 400px;">
                    <canvas id="feature-chart"></canvas>
                </div>
            </section>

            <!-- Misclassifications -->
            <section id="misclass" class="glass-card">
                <h2>Misclassification Examples</h2>
                <p class="section-desc">Common prediction errors on the test set.</p>
                <div class="misclass-grid" id="misclass-grid"></div>
            </section>
        </div>

        <!-- ============ MODELS SECTION ============ -->
        <div id="section-models" class="section-content">
            <!-- Model Comparison -->
            <section id="comparison" class="glass-card">
                <h2>Model Comparison by Track</h2>
                <div class="chart-container" style="height: 400px;">
                    <canvas id="radar-chart"></canvas>
                </div>
            </section>

            <!-- Model Performance Table -->
            <section id="performance" class="glass-card">
                <h2>Model Performance Table</h2>
                <div class="table-container">
                    <table id="metrics-table">
                        <thead>
                            <tr>
                                <th>Class</th>
                                <th>Precision</th>
                                <th>Recall</th>
                                <th>F1 Score</th>
                                <th>Support</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
        </div>

        <footer>
            <p>&copy; 2025 Wafer Defect Classification Project â€¢ AI-Driven Semiconductor Quality Control</p>
        </footer>
    </div>

    <script>
        // ============ CONSTANTS ============
        const MAPPING_TYPE = {
            0: "Center", 1: "Donut", 2: "Edge-Loc", 3: "Edge-Ring",
            4: "Loc", 5: "Random", 6: "Scratch", 7: "none"
        };

        const COLORS = {
            primary: '#6366f1',
            secondary: '#ec4899',
            accent: '#22d3ee',
            success: '#22c55e',
            warning: '#f59e0b',
            error: '#ef4444',
            classes: ['#6366f1', '#ec4899', '#22d3ee', '#f59e0b', '#22c55e', '#8b5cf6', '#ef4444', '#64748b']
        };

        // ============ THEME TOGGLE ============
        let isDarkMode = true;
        document.getElementById('theme-toggle').addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('light-mode', !isDarkMode);
            document.getElementById('theme-toggle').textContent = isDarkMode ? 'ðŸŒ™' : 'â˜€ï¸';
        });

        // ============ NAVIGATION ============
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`section-${tab.dataset.section}`).classList.add('active');
            });
        });

        // ============ TOAST SYSTEM ============
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${type === 'success' ? 'âœ“' : 'âœ•'}</span><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'toastOut 0.3s ease-out forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ============ DATA LOADING ============
        async function loadDatasetStats() {
            try {
                const res = await fetch('/api/dataset_stats');
                const data = await res.json();
                
                const statsGrid = document.getElementById('stats-grid');
                statsGrid.innerHTML = `
                    <div class="stat-item"><span class="stat-value">${data.total_samples.toLocaleString()}</span><span class="stat-label">Total Samples</span></div>
                    <div class="stat-item"><span class="stat-value">${data.train_size.toLocaleString()}</span><span class="stat-label">Train Size (${data.train_ratio}%)</span></div>
                    <div class="stat-item"><span class="stat-value">${data.test_size.toLocaleString()}</span><span class="stat-label">Test Size</span></div>
                    <div class="stat-item"><span class="stat-value">${data.num_features_selected}</span><span class="stat-label">Features Selected</span></div>
                `;
                
                // Class distribution chart
                renderDistributionChart(data.class_distribution);
            } catch (err) {
                console.error('Error loading stats:', err);
            }
        }

        function renderDistributionChart(distribution) {
            const ctx = document.getElementById('distribution-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: distribution.map(d => d.class),
                    datasets: [{
                        label: 'Sample Count',
                        data: distribution.map(d => d.count),
                        backgroundColor: COLORS.classes,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: { 
                            grid: { display: false },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        async function loadConfusionMatrix() {
            try {
                const res = await fetch('/api/confusion_matrix');
                const data = await res.json();
                window.confusionData = data;
                renderConfusionMatrix(data.matrix, data.labels, 'counts');
            } catch (err) {
                console.error('Error loading confusion matrix:', err);
            }
        }

        function renderConfusionMatrix(matrix, labels, mode = 'counts') {
            const container = document.getElementById('confusion-matrix');
            const displayMatrix = mode === 'percent' ? window.confusionData.matrix_normalized : matrix;
            
            let html = '<div class="cm-grid">';
            html += '<div class="cm-corner"></div>';
            labels.forEach(l => html += `<div class="cm-header">${l}</div>`);
            
            displayMatrix.forEach((row, i) => {
                html += `<div class="cm-label">${labels[i]}</div>`;
                row.forEach((val, j) => {
                    const maxVal = Math.max(...displayMatrix.flat());
                    const intensity = val / maxVal;
                    const isDiagonal = i === j;
                    const displayVal = mode === 'percent' ? `${val.toFixed(1)}%` : val;
                    html += `<div class="cm-cell ${isDiagonal ? 'diagonal' : ''}" 
                                  style="background: rgba(99, 102, 241, ${intensity * 0.8})">${displayVal}</div>`;
                });
            });
            html += '</div>';
            html += '<div class="cm-axis-labels"><span>Predicted â†’</span><span class="cm-true">â†‘ True</span></div>';
            container.innerHTML = html;
        }

        // CM toggle
        document.querySelectorAll('.cm-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.cm-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                if (window.confusionData) {
                    renderConfusionMatrix(window.confusionData.matrix, window.confusionData.labels, btn.dataset.mode);
                }
            });
        });

        async function loadClassMetrics() {
            try {
                const res = await fetch('/api/class_metrics');
                const data = await res.json();
                renderClassMetricsChart(data.filter(d => d.class !== 'Macro Avg'));
                renderMetricsTable(data);
            } catch (err) {
                console.error('Error loading class metrics:', err);
            }
        }

        function renderClassMetricsChart(metrics) {
            const ctx = document.getElementById('class-metrics-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: metrics.map(m => m.class),
                    datasets: [
                        { label: 'Precision', data: metrics.map(m => m.precision), backgroundColor: COLORS.primary },
                        { label: 'Recall', data: metrics.map(m => m.recall), backgroundColor: COLORS.secondary },
                        { label: 'F1 Score', data: metrics.map(m => m.f1), backgroundColor: COLORS.accent }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            labels: { color: '#f8fafc' }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 100,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: { 
                            grid: { display: false },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        function renderMetricsTable(metrics) {
            const tbody = document.querySelector('#metrics-table tbody');
            tbody.innerHTML = metrics.map(m => `
                <tr class="${m.class === 'Macro Avg' ? 'highlight-row' : ''}">
                    <td><span class="badge ${m.class === 'Macro Avg' ? 'macro' : 'track'}">${m.class}</span></td>
                    <td>${m.precision}%</td>
                    <td>${m.recall}%</td>
                    <td>
                        <div class="table-bar-container">
                            <span>${m.f1}%</span>
                            <div class="mini-bar-bg"><div class="mini-bar-fill" style="width: ${m.f1}%"></div></div>
                        </div>
                    </td>
                    <td>${m.support}</td>
                </tr>
            `).join('');
        }

        async function loadFeatureImportance() {
            try {
                const res = await fetch('/api/feature_importance?n=15');
                const data = await res.json();
                renderFeatureChart(data);
            } catch (err) {
                console.error('Error loading features:', err);
            }
        }

        function renderFeatureChart(features) {
            const ctx = document.getElementById('feature-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: features.map(f => f.Feature ? f.Feature.substring(0, 25) : 'Unknown'),
                    datasets: [{
                        label: 'Importance',
                        data: features.map(f => f.Importance || 0),
                        backgroundColor: 'rgba(99, 102, 241, 0.7)',
                        borderColor: '#6366f1',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { 
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#94a3b8' }
                        },
                        y: { 
                            grid: { display: false },
                            ticks: { color: '#94a3b8', font: { size: 11 } }
                        }
                    }
                }
            });
        }

        async function loadModelComparison() {
            try {
                const res = await fetch('/api/model_comparison');
                const data = await res.json();
                if (data.length > 0) renderRadarChart(data);
            } catch (err) {
                console.error('Error loading comparison:', err);
            }
        }

        function renderRadarChart(models) {
            const ctx = document.getElementById('radar-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: models.map(m => m.track),
                    datasets: [
                        {
                            label: 'F1 Score',
                            data: models.map(m => m.f1),
                            backgroundColor: COLORS.primary,
                            borderRadius: 6
                        },
                        {
                            label: 'Recall',
                            data: models.map(m => m.recall),
                            backgroundColor: COLORS.secondary,
                            borderRadius: 6
                        },
                        {
                            label: 'Precision',
                            data: models.map(m => m.precision),
                            backgroundColor: COLORS.accent,
                            borderRadius: 6
                        },
                        {
                            label: 'Generalization (100 - Overfit)',
                            data: models.map(m => 100 - m.overfit_gap),
                            backgroundColor: COLORS.success,
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            labels: { color: '#f8fafc' },
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'Track Performance Comparison',
                            color: '#f8fafc',
                            font: { size: 14, weight: '600' }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 100,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { 
                                color: '#94a3b8',
                                callback: function(value) { return value + '%'; }
                            }
                        },
                        x: { 
                            grid: { display: false },
                            ticks: { color: '#f8fafc', font: { weight: '600' } }
                        }
                    }
                }
            });
        }

        async function loadMisclassifications() {
            try {
                const res = await fetch('/api/misclassifications?limit=8');
                const data = await res.json();
                const container = document.getElementById('misclass-grid');
                container.innerHTML = data.map(m => `
                    <div class="misclass-item">
                        <span class="misclass-true">True: ${m.true_label}</span>
                        <span class="misclass-arrow">â†’</span>
                        <span class="misclass-pred">Pred: ${m.predicted_label}</span>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Error loading misclassifications:', err);
            }
        }

        // ============ GALLERY ============
        function populateGallery() {
            const grid = document.getElementById('gallery-grid');
            for (let i = 0; i <= 7; i++) {
                grid.innerHTML += `
                    <div class="defect-card">
                        <div class="image-wrapper">
                            <img src="assets/defect_${i}.png" alt="${MAPPING_TYPE[i]}" onerror="this.src='https://via.placeholder.com/150?text=No+Img'">
                        </div>
                        <div class="card-info"><h3>${MAPPING_TYPE[i]}</h3></div>
                    </div>
                `;
            }
        }

        // ============ CLASSIFIER ============
        let currentWaferIndex = null;
        let currentGroundTruth = null;
        const classificationHistory = [];

        const btnRandom = document.getElementById('btn-random');
        const btnClassify = document.getElementById('btn-classify');
        const waferPreview = document.getElementById('wafer-preview');
        const gtLabel = document.getElementById('gt-label');
        const predLabel = document.getElementById('pred-label');
        const probaContainer = document.getElementById('proba-container');
        const thresholdSlider = document.getElementById('threshold-slider');
        const thresholdValue = document.getElementById('threshold-value');
        const confidenceBadge = document.getElementById('confidence-badge');

        thresholdSlider.addEventListener('input', () => {
            thresholdValue.textContent = `${thresholdSlider.value}%`;
        });

        function addToHistory(groundTruth, prediction, isCorrect) {
            classificationHistory.unshift({ groundTruth, prediction, isCorrect });
            if (classificationHistory.length > 8) classificationHistory.pop();
            renderHistory();
        }

        function renderHistory() {
            const panel = document.getElementById('history-panel');
            const container = document.getElementById('history-items');
            if (classificationHistory.length === 0) { panel.style.display = 'none'; return; }
            panel.style.display = 'block';
            container.innerHTML = classificationHistory.map(item => `
                <div class="history-item ${item.isCorrect ? 'correct' : 'incorrect'}">
                    <span class="history-icon">${item.isCorrect ? 'âœ“' : 'âœ•'}</span>
                    <span>${item.prediction}</span>
                </div>
            `).join('');
        }

        async function pickRandomWafer() {
            btnRandom.disabled = true;
            btnRandom.innerHTML = '<span class="spinner"></span>Picking...';
            waferPreview.classList.add('skeleton-pulse');
            waferPreview.innerHTML = '';

            const filterVal = document.getElementById('class-filter').value;
            const url = filterVal === 'all' ? '/api/random_wafer' : `/api/random_wafer?type=${filterVal}`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                currentWaferIndex = data.index;
                currentGroundTruth = data.label;
                
                const img = new Image();
                img.src = `data:image/png;base64,${data.image}`;
                img.onload = () => {
                    waferPreview.classList.remove('skeleton-pulse');
                    waferPreview.appendChild(img);
                };

                gtLabel.innerText = data.label;
                predLabel.innerText = '---';
                confidenceBadge.textContent = '';
                document.getElementById('match-indicator').innerHTML = '';
                probaContainer.innerHTML = '<div class="placeholder-text">Ready to classify...</div>';
                btnClassify.disabled = false;
                
                if (document.getElementById('auto-classify').checked) {
                    setTimeout(() => classifyWafer(), 300);
                }
            } catch (err) {
                console.error(err);
                waferPreview.classList.remove('skeleton-pulse');
                waferPreview.innerHTML = '<div class="placeholder">Error loading</div>';
                showToast('Failed to load wafer', 'error');
            } finally {
                btnRandom.disabled = false;
                btnRandom.innerText = 'Pick Wafer';
            }
        }

        async function classifyWafer() {
            if (currentWaferIndex === null) return;
            
            btnClassify.disabled = true;
            btnClassify.innerHTML = '<span class="spinner"></span>Classifying...';
            
            try {
                const threshold = parseInt(thresholdSlider.value) / 100;
                const res = await fetch('/api/classify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ index: currentWaferIndex, threshold })
                });
                const data = await res.json();
                
                predLabel.innerText = data.prediction;
                confidenceBadge.textContent = `${data.confidence}%`;
                confidenceBadge.className = `confidence-badge ${data.confidence >= 80 ? 'high' : data.confidence >= 50 ? 'medium' : 'low'}`;
                
                const isCorrect = data.prediction === currentGroundTruth;
                document.getElementById('match-indicator').innerHTML = `
                    <div class="match-badge ${isCorrect ? 'correct' : 'incorrect'}">
                        ${isCorrect ? 'âœ“ Correct' : 'âœ• Mismatch'}
                    </div>
                `;
                
                addToHistory(currentGroundTruth, data.prediction, isCorrect);
                showToast(isCorrect ? 'Correct!' : `Predicted: ${data.prediction}`, isCorrect ? 'success' : 'error');
                
                probaContainer.innerHTML = data.probabilities
                    .sort((a, b) => b.score - a.score)
                    .map(p => {
                        const pct = (p.score * 100).toFixed(1);
                        const isWinner = p.label === data.prediction;
                        return `
                            <div class="proba-row">
                                <span class="proba-label ${isWinner ? 'highlight-text' : ''}">${p.label}</span>
                                <div class="proba-bar-bg">
                                    <div class="proba-bar-fill ${isWinner ? 'fill-winner' : ''}" style="width: ${pct}%"></div>
                                </div>
                                <span class="proba-val">${pct}%</span>
                            </div>
                        `;
                    }).join('');
            } catch (err) {
                console.error(err);
                probaContainer.innerText = "Error";
                showToast('Classification failed', 'error');
            } finally {
                btnClassify.disabled = false;
                btnClassify.innerText = 'Classify Wafer';
            }
        }

        btnRandom.addEventListener('click', pickRandomWafer);
        btnClassify.addEventListener('click', classifyWafer);

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
            if (e.code === 'Space') { e.preventDefault(); if (!btnRandom.disabled) pickRandomWafer(); }
            if (e.code === 'Enter') { e.preventDefault(); if (!btnClassify.disabled) classifyWafer(); }
        });

        // ============ BATCH CLASSIFICATION ============
        document.getElementById('btn-batch').addEventListener('click', async () => {
            const batchSize = parseInt(document.getElementById('batch-size').value) || 20;
            const btn = document.getElementById('btn-batch');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Running...';
            
            try {
                // Generate random indices
                const res = await fetch('/api/dataset_stats');
                const stats = await res.json();
                const indices = Array.from({ length: batchSize }, () => Math.floor(Math.random() * stats.total_samples));
                
                const batchRes = await fetch('/api/batch_classify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ indices })
                });
                const data = await batchRes.json();
                
                document.getElementById('batch-results').style.display = 'block';
                document.getElementById('batch-accuracy').textContent = `${data.accuracy}%`;
                document.getElementById('batch-correct').textContent = data.correct;
                document.getElementById('batch-total').textContent = data.total;
                
                document.getElementById('batch-items').innerHTML = data.results.map(r => `
                    <div class="batch-item ${r.correct ? 'correct' : 'incorrect'}">
                        <span class="batch-icon">${r.correct ? 'âœ“' : 'âœ•'}</span>
                        <span class="batch-gt">${r.ground_truth}</span>
                        <span class="batch-arrow">â†’</span>
                        <span class="batch-pred">${r.prediction}</span>
                        <span class="batch-conf">${r.confidence}%</span>
                    </div>
                `).join('');
                
                showToast(`Batch complete: ${data.accuracy}% accuracy`, 'success');
            } catch (err) {
                console.error(err);
                showToast('Batch classification failed', 'error');
            } finally {
                btn.disabled = false;
                btn.innerText = 'Run Batch Classification';
            }
        });

        // ============ INITIALIZE ============
        document.addEventListener('DOMContentLoaded', () => {
            populateGallery();
            loadDatasetStats();
            loadConfusionMatrix();
            loadClassMetrics();
            loadFeatureImportance();
            loadModelComparison();
            loadMisclassifications();
        });
    </script>
</body>
</html>